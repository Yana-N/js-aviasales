document.addEventListener("DOMContentLoaded",(function(){const t=document.querySelector(".form-search"),e=document.querySelector(".input__cities-from"),n=document.querySelector(".dropdown__cities-from"),a=document.querySelector(".input__cities-to"),r=document.querySelector(".dropdown__cities-to"),s=document.querySelector(".input__date-depart"),i=document.querySelector("#cheapest-ticket"),o=document.querySelector("#other-cheap-tickets");let c=[];const d=(t,e,n=console.error)=>{const a=new XMLHttpRequest;a.open("GET",t),a.addEventListener("readystatechange",()=>{4===a.readyState&&(200===a.status?e(a.response):n(a.status))}),a.send()},l=(t,e)=>{if(e.textContent="",t.value){c.filter(e=>e.name.toLowerCase().startsWith(t.value.toLowerCase())).forEach(t=>{const n=document.createElement("li");n.classList.add("dropdown__city"),n.textContent=t.name,e.append(n)})}},u=(t,e,n)=>{const a=t.target,r=a.innerText;"li"===a.tagName.toLowerCase()&&(e.value=r,n.textContent="")},m=t=>c.find(e=>e.code===t).name,p=t=>{const e=document.createElement("article");e.classList.add("ticket");let n="";var a;return n=t?`\n\t\t\t<h3 class="agent">${t.gate}</h3>\n\t\t\t<div class="ticket__wrapper">\n\t\t\t\t<div class="left-side">\n\t\t\t\t\t<a href="${(t=>{let e="https://www.aviasales.ru/search/";e+=t.origin;const n=new Date(t.depart_date),a=n.getDate();e+=a<10?"0"+a:a;const r=n.getMonth()+1;return e+=r<10?"0"+r:r,e+=t.destination,e+="1",e})(t)}" target="_blank" class="button button__buy">Купить\n\t\t\t\t\t\tза ${t.value}₽</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="right-side">\n\t\t\t\t\t<div class="block-left">\n\t\t\t\t\t\t<div class="city__from">Вылет из города\n\t\t\t\t\t\t\t<span class="city__name">${m(t.origin)}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="date">${(t=>new Date(t).toLocaleDateString("ru",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}))(t.depart_date)}</div>\n\t\t\t\t\t</div>\n\t\t\t\n\t\t\t\t\t<div class="block-right">\n\t\t\t\t\t\t<div class="changes">${a=t.number_of_changes,a?1===a?"С 1 пересадкой":"С 2 пересадками":"Без пересадок"}</div>\n\t\t\t\t\t\t<div class="city__to">Город назначения:\n\t\t\t\t\t\t\t<span class="city__name">${m(t.destination)}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t`:`К сожалению, билеты на ${date} не найдены`,e.insertAdjacentHTML("afterbegin",n),e},v=(t,e)=>{const n=JSON.parse(t).best_prices;(t=>{i.innerHTML="<h2>Самый дешевый билет на выбранную дату</h2>";const e=p(t[0]);i.append(e)})(n.filter(t=>t.depart_date===e)),(t=>{o.innerHTML="<h2>Самые дешевые билеты на другие даты</h2>",t.sort((t,e)=>t.value-e.value);for(let e=0;e<10&&e<t.length;e++){const n=p(t[e]);o.append(n)}})(n)};e.addEventListener("input",()=>{l(e,n)}),a.addEventListener("input",()=>{l(a,r)}),n.addEventListener("click",t=>{u(t,e,n)}),r.addEventListener("click",t=>{u(t,a,r)}),t.addEventListener("submit",t=>{t.preventDefault(),i.innerHTML="<h2>Самый дешевый билет на выбранную дату</h2>",o.innerHTML="<h2>Самые дешевые билеты на другие даты</h2>";const n={from:c.find(t=>e.value===t.name),to:c.find(t=>a.value===t.name),when:s.value};if(n.from&&n.to){const t=`?depart_date=${n.when}&origin=${n.from.code}&destination=${n.to.code}&one_way=true`;d("http://min-prices.aviasales.ru/calendar_preload"+t,t=>v(t,n.when),t=>{alert("В этом направлении нет рейсов"),console.error(t)})}else alert("Введите корректное название города!")}),d("../db/cities.json",t=>{c=JSON.parse(t).filter(t=>t.name),c.sort((t,e)=>t.name>e.name?1:t.name<e.name?-1:0)})}));